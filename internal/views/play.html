<script>
  /*************************************************************************************************
   * This view is basically the same as the index view. The only difference is that the user is
   * playing the game. The user will be able to select the answers to the questions and submit
   * the game. The user will also be able to see the results of the game.
   * *****************************************************************************/
</script>
<!DOCTYPE html>
<html lang="en">
  <head>
    {{template "head" .}}
  </head>
  <body>
    <main>
      <!-- The user is starting an existing game  -->
      <div id="start-game-session">
        <h1>Start Playing {{.Game.Name}}</h1>
        <p>Created by {{.Game.PlayerName}}</p>
        <input
          type="text"
          id="player_name"
          placeholder="Your Name"
          class="mb-4"
        />
        <!-- Not allowing users to pick size for now -->
        <input type="hidden" id="gameId" value="{{.Game.ID}}" />
        <button onclick="createGame()">Start Game</button>
      </div>

      <!-- The user has already started the game but has not finished it yet -->
      <div id="game-container"></div>

      <!-- The has been finished but not submitted  -->
      <div id="game-container-done">
        <h2>You have completed this game!</h2>
        <img src="/public/images/thank_you_4000.webp" class="thumbnail" />
        <p class="mb-4">
          Submit your answers to see how well you know {{.Game.PlayerName}}.
        </p>
        <button onclick="submitGame()">Submit Answers</button>
      </div>

      <!-- The user has finished and submitted the game. They will see the stats here-->
      <div id="game-container-submitted">
        <h2>Results for {{.Game.Name}}</h2>
        <img src="/public/images/search_4000.webp" class="thumbnail" />
        <p>Here's how well you know {{.Game.PlayerName}}:</p>
        <div id="game-results"></div>
      </div>

      <script>
        console.log("{{.Session}}");

        /*************************************************************************************************
         * Four screens are possible:
         * 1. Create a game player (default)
         * 2. Play the game (the user ahs submitted the game player information)
         * 3. Game is done (the user has answered all the questions but not submitted)
         * 4. Game is submitted (the user has submitted the game)
         * *****************************************************************************/
        document.addEventListener("DOMContentLoaded", () => {
          // Make sure gameId is available before checking localStorage
          const gameId = document.getElementById("gameId").value;
          if (!(gameId > 0)) {
            renderView("create");
            return;
          }

          const gameState = getGameStateFromLocalStorage(
            `wattamellon_token_player_${gameId}`
          );

          console.log(gameId);
          if (gameState.game_id) {
            if (gameState.is_submitted) {
              updateFinalResults();

              renderView("submitted");
              return;
            }

            if (gameState.is_complete) {
              renderView("done");
              return;
            }

            renderView("game");
          } else {
            renderView("create");
          }
        });

        /*************************************************************************************************
         * The new game session is created here. The user will be able to select the answers to the
         * **********************************************************************************************/
        async function createGame() {
          const playerName = document.getElementById("player_name").value;
          const gameId = document.getElementById("gameId").value;
          const playerToken = generateToken();

          // alert the user if they have not selected a thumbnail or have not entered a name
          if (!playerName) {
            alert("Please enter your name");
            return;
          }

          const res = await fetch("/new-game-session", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              player_token: playerToken,
              player_name: playerName,
              game_id: Number(gameId),
              answers: "{}",
            }),
          });

          const { data, success } = await res.json();

          // get the questions from the game and set up an empty answer for each one to start with
          const gameQuestions = `{{.Game.Questions}}`;
          const gameQuestionsParsed = JSON.parse(gameQuestions);
          const gameQuestionsKeys = Object.keys(gameQuestionsParsed);

          const emtpyAnswers = gameQuestionsKeys.reduce((acc, key) => {
            acc[key] = "";
            return acc;
          }, {});

          if (success) {
            // update the game token with the order of the questions
            updateGameState({
              player_token: data.player_token,
              game_id: data.game_id,
              answers: emtpyAnswers,
              is_complete: false,
              current_index: 0,
              success_rate: 0,
              id: data.id,
            });
            renderView("game");
          } else {
            alert("Error creating game: " + data.error);
          }
        }

        /*************************************************************************************************
         * I am responsible for three things:
         * 1. Rendering the cards on the initial load
         * 2. Rendering the next cards when the user selects one option
         * 3. Updating the game token with the current game state
         * **********************************************************************************************/
        function renderCards() {
          // get the game token from the local storage, so the state is preserved
          const gameState = getGameStateFromLocalStorage(
            `wattamellon_token_player_${gameId}`
          );
          const categorieKeys = Object.keys(gameState.answers);

          // also get the current index of the game so we know which question to show
          let currentIndex = gameState.current_index;

          // I need to append to this container the current question and the options
          const container = document.getElementById("game-container");

          function showNextQuestion() {
            if (currentIndex >= categorieKeys.length) {
              renderView("done");
              return;
            }

            // based on the current index, get the current category key
            const categoryKey = categorieKeys[currentIndex];

            // based on the current category key, get the question
            const { question, options } = categories[categoryKey];
            // and also the options
            const gameQuestions = `{{.Game.Questions}}`;
            const selectedOptionsParsed = JSON.parse(gameQuestions);
            const selectedOptions = selectedOptionsParsed[categoryKey].options;

            container.innerHTML = "";

            // Create question counter
            const h4 = document.createElement("h4");
            h4.textContent = `Question ${currentIndex + 1} of ${
              categorieKeys.length
            }`;
            container.appendChild(h4);

            // Create question text
            const h3 = document.createElement("h3");
            h3.textContent = question;
            container.appendChild(h3);

            // Create options container
            const optionsContainer = document.createElement("div");
            optionsContainer.className = "options-container";
            container.appendChild(optionsContainer);

            // when the user selects an option, also let them know if they are correct or not
            selectedOptions.forEach((option) => {
              const card = document.createElement("div");
              card.className = "option-card";
              card.textContent = option.value;
              card.onclick = () => {
                currentIndex++;
                gameState.answers[categoryKey] = {
                  selection: option.id,
                  isCorrect:
                    option.id === selectedOptionsParsed[categoryKey].selection,
                };
                gameState.current_index = currentIndex;
                gameState.is_complete = currentIndex >= categorieKeys.length;
                updateGameState(gameState);
                showNextQuestion();
              };
              optionsContainer.appendChild(card);
            });
          }

          // call the function on initial load
          showNextQuestion();
        }

        /*************************************************************************************************
         * This function is responsible for submitting the game. It will send the answers to the server
         * and if successful, it will alert the user and display the results
         * **********************************************************************************************/
        async function submitGame() {
          // check that the user has answered all the questions

          const gameState = getGameStateFromLocalStorage(
            `wattamellon_token_player_${gameId}`
          );
          const { player_token, id, answers } = gameState;

          // now, based on the answer values and the game questions, check the total number of questions
          // answered correctly and incorrectly.
          const gameQuestions = JSON.parse(`{{.Game.Questions}}`);
          let incorrectAnswers = Object.keys(answers).filter(
            (key) => answers[key].isCorrect === false
          ).length;
          let correctAnswers = Object.keys(answers).filter(
            (key) => answers[key].isCorrect === true
          ).length;

          // check if the user has answered all the questions
          let isComplete = true;
          Object.keys(gameQuestions).forEach((key) => {
            if (!answers[key]) {
              isComplete = false;
            }
          });

          const successRate =
            (correctAnswers / Object.keys(gameQuestions).length) * 100;

          if (!isComplete) {
            alert("Please answer all the questions before submitting");
            return;
          }

          const res = await fetch("/submit-game-session", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              answers: JSON.stringify(answers),
              success_rate: successRate,
              player_token,
              id,
            }),
          });

          const data = await res.json();
          if (data.success) {
            gameState.incorrect_answers = incorrectAnswers;
            gameState.correct_answers = correctAnswers;
            gameState.success_rate = successRate;
            gameState.is_submitted = true;
            updateGameState(gameState);

            updateFinalResults();

            alert("Game submitted! You can now view the results.");
            renderView("submitted");
          } else {
            alert("Error submitting game.");
          }
        }

        /*************************************************************************************************
         * Update the results of the game. Show the total percentage as well as the correct and incorrect
         * answers.
         * **********************************************************************************************/
        function updateFinalResults() {
          const gameState = getGameStateFromLocalStorage(
            `wattamellon_token_player_${gameId}`
          );
          const { answers, success_rate, correct_answers, incorrect_answers } =
            gameState;

          const resultsContainer = document.getElementById("game-results");

          // game questions
          const gameQuestions = `{{.Game.Questions}}`;
          const gameQuestionsParsed = JSON.parse(gameQuestions);

          // Calculate score percentage for display
          const scorePercentage = Math.round(success_rate);
          const totalQuestions = correct_answers + incorrect_answers;
          const correctAngle = (correct_answers / totalQuestions) * 360;

          // Create the score summary with pie chart
          const scoreSummary = document.createElement("div");
          scoreSummary.className = "score-summary";
          scoreSummary.innerHTML = `
            <h3>Your Score: ${scorePercentage}%</h3>
            <div class="pie-chart-container">
              <div class="pie-chart" id="results-pie-chart"></div>
              <div class="pie-chart-legend">
                <div class="legend-item">
                  <span class="legend-color correct-color"></span>
                  <span class="legend-label">Correct: ${correct_answers}</span>
                </div>
                <div class="legend-item">
                  <span class="legend-color incorrect-color"></span>
                  <span class="legend-label">Incorrect: ${incorrect_answers}</span>
                </div>
              </div>
            </div>
          `;

          // Create the answer breakdown title
          const breakdownTitle = document.createElement("h3");
          breakdownTitle.textContent = "Answer Breakdown:";

          // Create the accordion container
          const accordionContainer = document.createElement("div");
          accordionContainer.className = "accordion-container";

          // Clear the results container and add the new elements
          resultsContainer.innerHTML = "";
          resultsContainer.appendChild(scoreSummary);
          resultsContainer.appendChild(breakdownTitle);
          resultsContainer.appendChild(accordionContainer);

          // Get CSS variables for colors
          const computedStyle = getComputedStyle(document.documentElement);
          const successColor =
            computedStyle.getPropertyValue("--dr-success") || "#4CAF50";
          const dangerColor =
            computedStyle.getPropertyValue("--dr-danger") || "#FF5252";

          // Set the pie chart gradient using CSS variables
          const pieChart = document.getElementById("results-pie-chart");
          pieChart.style.backgroundImage = `conic-gradient(
            ${successColor} 0deg ${correctAngle}deg,
            ${dangerColor} ${correctAngle}deg 360deg
          )`;

          // Add each question as an accordion item
          Object.keys(answers).forEach((key, index) => {
            const question = categories[key].question;
            const selectedOption =
              categories[key]["options"][answers[key].selection];
            const creatorSelectOption =
              categories[key]["options"][gameQuestionsParsed[key].selection];
            const isCorrect = answers[key].isCorrect;

            const accordionItem = document.createElement("div");
            accordionItem.className = `accordion-item ${
              isCorrect ? "correct" : "incorrect"
            }`;

            const accordionHeader = document.createElement("div");
            accordionHeader.className = "accordion-header";
            accordionHeader.onclick = function () {
              toggleAccordion(index);
            };

            const questionText = document.createElement("p");
            questionText.textContent = question;

            const accordionIcon = document.createElement("div");
            accordionIcon.className = "accordion-icon";
            accordionIcon.innerHTML =
              '<span class="accordion-plus">+</span><span class="accordion-minus">−</span>';

            accordionHeader.appendChild(questionText);
            accordionHeader.appendChild(accordionIcon);

            const accordionContent = document.createElement("div");
            accordionContent.className = "accordion-content";

            const yourAnswer = document.createElement("p");
            yourAnswer.innerHTML = `<strong>Your answer:</strong> ${selectedOption}`;

            const correctAnswer = document.createElement("p");
            correctAnswer.innerHTML = `<strong>${
              isCorrect ? "Correct!" : "Correct answer was:"
            }</strong> ${creatorSelectOption}`;

            accordionContent.appendChild(yourAnswer);
            accordionContent.appendChild(correctAnswer);

            accordionItem.appendChild(accordionHeader);
            accordionItem.appendChild(accordionContent);

            accordionContainer.appendChild(accordionItem);
          });

          // Add the toggle function for the accordion
          window.toggleAccordion = function (index) {
            const accordionItems = document.querySelectorAll(".accordion-item");
            accordionItems[index].classList.toggle("active");
          };
        }

        /*************************************************************************************************
         * It will hide and show the right elements based on the view that is passed in
         * **********************************************************************************************/
        function renderView(view) {
          switch (view) {
            case "create":
              document.getElementById("start-game-session").style.display =
                "block";
              document.getElementById("game-container").style.display = "none";
              document.getElementById("game-container-done").style.display =
                "none";
              document.getElementById(
                "game-container-submitted"
              ).style.display = "none";
              break;
            case "game":
              document.getElementById("start-game-session").style.display =
                "none";
              document.getElementById("game-container").style.display = "block";
              document.getElementById("game-container-done").style.display =
                "none";
              document.getElementById(
                "game-container-submitted"
              ).style.display = "none";
              renderCards();
              break;
            case "done":
              document.getElementById("start-game-session").style.display =
                "none";
              document.getElementById("game-container").style.display = "none";
              document.getElementById("game-container-done").style.display =
                "block";
              document.getElementById(
                "game-container-submitted"
              ).style.display = "none";
              break;

            case "submitted":
              document.getElementById("start-game-session").style.display =
                "none";
              document.getElementById("game-container").style.display = "none";
              document.getElementById("game-container-done").style.display =
                "none";
              document.getElementById(
                "game-container-submitted"
              ).style.display = "block";

            default:
              break;
          }
        }
      </script>
    </main>
  </body>
</html>
